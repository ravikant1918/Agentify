{% extends "base.html" %}

{% block title %}Agentify - Chat{% endblock %}

{% block content %}
<div class="flex flex-col h-screen pt-4">
    <!-- Chat Container -->
    <div class="flex-1 flex flex-col max-w-4xl mx-auto w-full bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">

        <!-- Thread Header -->
        <div class="border-b border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                        {% if thread_id %}
                            {{ current_thread.title if current_thread else "New Chat" }}
                        {% else %}
                            New Chat
                        {% endif %}
                    </h2>
                    {% if thread_id %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        {{ messages|length }} messages
                    </p>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-2">
                    <button class="btn btn-outline btn-sm"
                            onclick="createNewThread()">
                        New Chat
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messages-container"
             class="flex-1 overflow-y-auto p-4 space-y-4"
             hx-get="/api/threads/{{ thread_id or 'None' }}/messages"
             hx-trigger="load"
             hx-swap="innerHTML">

            <!-- Messages will be loaded here -->
            {% if messages %}
                {% for message in messages %}
                <div class="flex {{ 'justify-end' if message.role == 'user' else 'justify-start' }}">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg {{
                        'bg-primary text-white' if message.role == 'user'
                        else 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100' }}">
                        <p class="text-sm">{{ message.content }}</p>
                        <p class="text-xs opacity-70 mt-1">{{ message.timestamp[:5] if message.timestamp else '' }}</p>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Welcome Message -->
                <div class="text-center py-12">
                    <div class="mb-4">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Welcome to Agentify</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-6">Start a conversation with your AI assistant</p>

                    <!-- Quick Actions -->
                    <div class="flex flex-wrap justify-center gap-2">
                        <button class="btn btn-outline btn-sm"
                                onclick="sendQuickMessage('What tools are available?')">
                            Available Tools
                        </button>
                        <button class="btn btn-outline btn-sm"
                                onclick="sendQuickMessage('Help me get started')">
                            Get Started
                        </button>
                        <button class="btn btn-outline btn-sm"
                                onclick="sendQuickMessage('Show me examples')">
                            Examples
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 dark:border-gray-700 p-4">
            <form id="chat-form"
                  hx-post="/api/chat"
                  hx-target="#messages-container"
                  hx-swap="beforeend"
                  hx-on:htmx:before-request="showLoading()"
                  hx-on:htmx:after-request="hideLoading(); clearInput(); htmx.trigger('#thread-list', 'newThread')"
                  class="flex gap-2">

                <input type="hidden" name="thread_id" value="{{ thread_id or '' }}">

                <div class="flex-1">
                    <textarea
                        name="message"
                        id="message-input"
                        placeholder="Type your message..."
                        class="textarea textarea-bordered w-full resize-none"
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                        required></textarea>
                </div>

                <button type="submit"
                        class="btn btn-primary"
                        id="send-button">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
            
            <!-- Loading indicator -->
            <div id="loading-indicator" class="hidden mt-2 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-primary border-t-transparent"></div>
                <span>AI is thinking...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Auto-resize textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// Handle Enter key
function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    }
}

// Clear input after send
function clearInput() {
    const input = document.getElementById('message-input');
    input.value = '';
    input.style.height = 'auto';
    input.focus();
}

// Show loading indicator and disable send button
function showLoading() {
    const button = document.getElementById('send-button');
    const input = document.getElementById('message-input');
    const indicator = document.getElementById('loading-indicator');
    
    button.disabled = true;
    button.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>';
    input.disabled = true;
    indicator.classList.remove('hidden');
}

// Hide loading indicator and enable send button
function hideLoading() {
    const button = document.getElementById('send-button');
    const input = document.getElementById('message-input');
    const indicator = document.getElementById('loading-indicator');
    
    button.disabled = false;
    button.innerHTML = '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>';
    input.disabled = false;
    indicator.classList.add('hidden');
}

// Send quick message
function sendQuickMessage(message) {
    const input = document.getElementById('message-input');
    input.value = message;
    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
}

// Switch to a different thread
function switchToThread(threadId) {
    // Update the hidden input
    document.querySelector('input[name="thread_id"]').value = threadId;

    // Reload messages for the new thread
    const messagesContainer = document.getElementById('messages-container');
    htmx.ajax('GET', `/api/threads/${threadId}/messages`, {
        target: messagesContainer,
        swap: 'innerHTML'
    });

    // Reload sidebar to highlight current thread
    const sidebarContainer = document.getElementById('thread-list');
    htmx.ajax('GET', `/api/threads/sidebar?current_thread_id=${threadId}`, {
        target: sidebarContainer,
        swap: 'innerHTML'
    });

    // Update URL without page reload
    window.history.pushState({}, '', `/?thread_id=${threadId}`);
}

// Create a new thread
function createNewThread() {
    // Clear thread_id to create new thread
    document.querySelector('input[name="thread_id"]').value = '';

    // Reload messages (will show welcome message)
    const messagesContainer = document.getElementById('messages-container');
    htmx.ajax('GET', '/api/threads/None/messages', {
        target: messagesContainer,
        swap: 'innerHTML'
    });

    // Reload sidebar
    const sidebarContainer = document.getElementById('thread-list');
    htmx.ajax('GET', '/api/threads/sidebar', {
        target: sidebarContainer,
        swap: 'innerHTML'
    });

    // Update URL
    window.history.pushState({}, '', '/');

    // Focus input
    document.getElementById('message-input').focus();
}

// Scroll to bottom when new messages arrive
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'messages-container') {
        evt.detail.target.scrollTop = evt.detail.target.scrollHeight;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Focus input
    document.getElementById('message-input').focus();
});
</script>
{% endblock %}